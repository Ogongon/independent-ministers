{% extends "base.html" %}
{% load static wagtailcore_tags wagtailembeds_tags %}

{% block content %}
<style>
    /* Homepage Specific Styles */
    .hero-section { position: relative; height: 85vh; width: 100%; }
    #map { height: 100%; width: 100%; z-index: 1; }
    
    .video-quadrant {
        position: absolute; bottom: 30px; right: 30px; width: 380px;
        background: rgba(255, 255, 255, 0.95);
        padding: 15px; z-index: 1000;
        box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        border-radius: 8px; border-left: 5px solid var(--color-accent);
    }
    .video-title { font-size: 1rem; margin-bottom: 10px; color: #333; }
    
    @media (max-width: 768px) {
        .hero-section { height: auto; display: flex; flex-direction: column-reverse; }
        #map { height: 400px; }
        .video-quadrant { position: relative; bottom: auto; right: auto; width: 100%; box-sizing: border-box; }
    }
</style>

<div class="hero-section">
    <div id="map"></div>

    {% if active_video %}
    <div class="video-quadrant">
        <h3 class="video-title">Weekly Update: {{ active_video.title }}</h3>
        
        {% if active_video.get_youtube_id %}
            <div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
                <iframe width="100%" height="100%" 
                    src="https://www.youtube.com/embed/{{ active_video.get_youtube_id }}?rel=0" 
                    style="position: absolute; top: 0; left: 0; border: 0;"
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                    allowfullscreen>
                </iframe>
            </div>
        {% else %}
            <p style="color:red; font-size:0.8rem;">Video URL format error.</p>
        {% endif %}

        <p style="font-size: 0.85rem; color: #666; margin-top: 8px; margin-bottom: 0;">
            Posted: {{ active_video.created_at|date:"M d, Y" }}
        </p>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Initialize Map centered on Mombasa
    var map = L.map('map').setView([-3.8, 39.7], 9);

    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    // Fetch pins from database
    fetch('/api/sites/')
        .then(response => response.json())
        .then(data => {
            data.sites.forEach(site => {
                var marker = L.marker([site.lat, site.lng]).addTo(map);
                var popupContent = `<b>${site.name}</b><br>${site.description}`;
                if (site.photo_url) {
                    popupContent += `<br><img src="${site.photo_url}" style="width:100%; margin-top:5px;">`;
                }
                marker.bindPopup(popupContent);
            });
        });
</script>
{% endblock %}